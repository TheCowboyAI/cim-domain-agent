# ACT Expert RAG Library Build Tools

<!-- Copyright (c) 2025 - Cowboy AI, LLC. -->

## Overview

This directory contains Python tools for building the RAG (Retrieval-Augmented Generation) library for the ACT Expert agent.

## Tools

### 1. `build_embeddings.py`
Generates embeddings from corpus markdown documents.

**Usage:**
```bash
python build_embeddings.py \
  --corpus ../rag/corpus/ \
  --output ../rag/embeddings/ \
  --model all-MiniLM-L6-v2
```

**What it does:**
- Parses markdown files from corpus directory
- Extracts sections with ID, tags, content
- Generates 384-dimensional embeddings using sentence-transformers
- Saves embeddings as .npz files with metadata JSON

**Output:**
```
../rag/embeddings/
├── embeddings.npz      # Numpy compressed embeddings
├── metadata.json       # Document metadata
└── stats.json          # Statistics
```

### 2. `build_index.py`
Builds FAISS and BM25 search indices.

**Usage:**
```bash
python build_index.py \
  --embeddings ../rag/embeddings/ \
  --output ../rag/index/ \
  --index-type Flat \
  --test
```

**Index Types:**
- `Flat`: Exact L2 distance search (default)
- `IVF`: Inverted file index (faster, approximate)
- `HNSW`: Hierarchical navigable small world (very fast, approximate)

**What it does:**
- Loads embeddings from build_embeddings.py
- Builds FAISS vector index for semantic search
- Builds BM25 keyword index
- Optionally runs test queries

**Output:**
```
../rag/index/
├── semantic.faiss      # FAISS vector index
├── keyword.pkl         # BM25 keyword index
└── index_config.json   # Index configuration
```

### 3. `build_tensors.py`
Builds knowledge graph tensor with PyTorch Geometric.

**Usage:**
```bash
python build_tensors.py \
  --corpus ../rag/corpus/ \
  --embeddings ../rag/embeddings/ \
  --output ../tensors/ \
  --train \
  --epochs 100
```

**What it does:**
- Parses corpus documents
- Extracts graph structure (nodes and edges)
- Builds PyTorch Geometric graph tensor
- Optionally trains GAT model for link prediction

**Output:**
```
../tensors/
├── category_graph.pt   # PyTorch Geometric graph
├── gnn_model.pt        # Trained GAT model
└── graph_stats.json    # Graph statistics
```

### 4. `query_rag.py`
Query interface for testing the RAG library.

**Usage:**
```bash
# Single query
python query_rag.py \
  --embeddings ../rag/embeddings/ \
  --index ../rag/index/ \
  --query "How do I verify functor laws?" \
  --type hybrid \
  --top-k 5

# Interactive mode
python query_rag.py \
  --embeddings ../rag/embeddings/ \
  --index ../rag/index/
```

**Query Types:**
- `semantic`: Dense vector search (FAISS)
- `keyword`: Sparse keyword search (BM25)
- `hybrid`: Combined ranking (default)

**Interactive Commands:**
```
Query> functor composition law
Query> :type semantic
Query> :k 10
Query> :content on
Query> :quit
```

## Complete Build Process

### Step 1: Install Dependencies
```bash
pip install -r requirements.txt
```

### Step 2: Build Embeddings
```bash
python build_embeddings.py \
  --corpus ../rag/corpus/ \
  --output ../rag/embeddings/
```

### Step 3: Build Indices
```bash
python build_index.py \
  --embeddings ../rag/embeddings/ \
  --output ../rag/index/ \
  --test
```

### Step 4: Build Knowledge Graph (Optional)
```bash
python build_tensors.py \
  --corpus ../rag/corpus/ \
  --embeddings ../rag/embeddings/ \
  --output ../tensors/ \
  --train \
  --epochs 100
```

### Step 5: Test Query Interface
```bash
python query_rag.py \
  --embeddings ../rag/embeddings/ \
  --index ../rag/index/ \
  --tensor ../tensors/ \
  --query "What are common functor violations?"
```

## Automated Build Script

Use the provided shell script for automated builds:

```bash
chmod +x build_all.sh
./build_all.sh
```

This will:
1. Check for required dependencies
2. Build embeddings
3. Build indices
4. Build knowledge graph tensor
5. Run test queries

## Directory Structure After Build

```
agents/act-expert/
├── rag/
│   ├── corpus/              # Source documents (created manually)
│   │   ├── category_theory.md
│   │   ├── functors.md
│   │   ├── violations.md
│   │   ├── natural_transformations.md
│   │   └── cim_patterns.md
│   ├── embeddings/          # Generated by build_embeddings.py
│   │   ├── embeddings.npz
│   │   ├── metadata.json
│   │   └── stats.json
│   └── index/               # Generated by build_index.py
│       ├── semantic.faiss
│       ├── keyword.pkl
│       └── index_config.json
├── tensors/                 # Generated by build_tensors.py
│   ├── category_graph.pt
│   ├── gnn_model.pt
│   └── graph_stats.json
└── tools/                   # This directory
    ├── build_embeddings.py
    ├── build_index.py
    ├── build_tensors.py
    ├── query_rag.py
    ├── requirements.txt
    └── README.md
```

## Performance Expectations

### Embedding Generation
- **Time:** ~10-30 seconds for 50 documents
- **Memory:** ~2GB RAM
- **Output Size:** ~5-10 MB

### Index Building
- **Time:** ~5-10 seconds
- **Memory:** ~1GB RAM
- **Output Size:** ~10-20 MB

### Knowledge Graph Building
- **Time:** ~1-2 minutes (with training)
- **Memory:** ~4GB RAM
- **Output Size:** ~20-50 MB

### Query Performance
- **Semantic Search:** <100ms per query
- **Keyword Search:** <50ms per query
- **Hybrid Search:** <150ms per query

## Troubleshooting

### Issue: "ModuleNotFoundError: No module named 'faiss'"
**Solution:** Install FAISS:
```bash
pip install faiss-cpu  # For CPU
# OR
pip install faiss-gpu  # For GPU
```

### Issue: "CUDA out of memory"
**Solution:** Use CPU version or reduce batch size in build scripts.

### Issue: "No documents found in corpus"
**Solution:** Ensure corpus markdown files have proper formatting with `**ID:**`, `**Tags:**`, and `**Type:**` fields.

### Issue: "Embeddings dimension mismatch"
**Solution:** Ensure all tools use the same embedding model (all-MiniLM-L6-v2 by default).

## Next Steps

After building the RAG library:
1. Integrate with Llama4 agent (see `../act-expert.v2.md`)
2. Deploy RAG service (FastAPI endpoint)
3. Connect to NATS for verification requests
4. Test with real DomainFunctor implementations

## References

- **Sentence Transformers:** https://www.sbert.net/
- **FAISS:** https://github.com/facebookresearch/faiss
- **BM25:** https://github.com/dorianbrown/rank_bm25
- **PyTorch Geometric:** https://pytorch-geometric.readthedocs.io/
