# Agent Domain API Documentation

## Overview

The Agent domain API provides commands, queries, and events for managing autonomous agents that can perform actions on behalf of users or organizations in the CIM system.

## Commands

### DeployAgent

Deploys a new agent to the system.

```rust
use cim_domain_agent::commands::DeployAgent;
use cim_domain_agent::{AgentType, AgentMetadata};

let command = DeployAgent {
    id: Uuid::new_v4(),
    agent_type: AgentType::Assistant,
    owner_id: user_id,
    metadata: AgentMetadata {
        name: "My Assistant".to_string(),
        description: Some("Personal AI assistant".to_string()),
        version: "1.0.0".to_string(),
        ..Default::default()
    },
};
```

**Fields:**
- `id`: Unique identifier for the agent (generated by caller)
- `agent_type`: Type of agent (Assistant, Analyzer, Executor, Monitor)
- `owner_id`: ID of the person or organization that owns this agent
- `metadata`: Agent metadata including name, description, and version

**Validation:**
- Agent ID must be unique
- Owner must exist
- Metadata name must be non-empty

**Events Emitted:**
- `AgentDeployed`

### ActivateAgent

Activates a deployed agent, making it available for use.

```rust
use cim_domain_agent::commands::ActivateAgent;

let command = ActivateAgent {
    id: agent_id,
};
```

**Fields:**
- `id`: Identifier of the agent to activate

**Validation:**
- Agent must exist
- Agent must be in Deployed or Suspended state

**Events Emitted:**
- `AgentActivated`

### SuspendAgent

Temporarily suspends an agent's operations.

```rust
use cim_domain_agent::commands::SuspendAgent;

let command = SuspendAgent {
    id: agent_id,
    reason: "Maintenance required".to_string(),
};
```

**Fields:**
- `id`: Identifier of the agent to suspend
- `reason`: Reason for suspension

**Events Emitted:**
- `AgentSuspended`

### ChangeAgentCapabilities

Modifies an agent's capabilities by adding or removing them.

```rust
use cim_domain_agent::commands::ChangeAgentCapabilities;

let command = ChangeAgentCapabilities {
    id: agent_id,
    add_capabilities: vec!["data_analysis".to_string(), "report_generation".to_string()],
    remove_capabilities: vec!["code_execution".to_string()],
};
```

**Fields:**
- `id`: Identifier of the agent
- `add_capabilities`: List of capability names to add
- `remove_capabilities`: List of capability names to remove

**Events Emitted:**
- `AgentCapabilitiesAdded` (if capabilities added)
- `AgentCapabilitiesRemoved` (if capabilities removed)

### GrantAgentPermissions

Grants permissions to an agent for accessing resources.

```rust
use cim_domain_agent::commands::GrantAgentPermissions;
use std::collections::HashSet;

let command = GrantAgentPermissions {
    id: agent_id,
    permissions: HashSet::from([
        "read:documents".to_string(),
        "write:reports".to_string(),
    ]),
};
```

**Fields:**
- `id`: Identifier of the agent
- `permissions`: Set of permission strings to grant

**Events Emitted:**
- `AgentPermissionsGranted`

### EnableAgentTools

Enables specific tools for an agent to use.

```rust
use cim_domain_agent::commands::EnableAgentTools;
use cim_domain_agent::ToolDefinition;

let command = EnableAgentTools {
    id: agent_id,
    tools: vec![
        ToolDefinition {
            name: "web_search".to_string(),
            version: "2.0".to_string(),
            endpoint: Some("https://api.search.com".to_string()),
            parameters: Default::default(),
        },
    ],
};
```

**Fields:**
- `id`: Identifier of the agent
- `tools`: List of tool definitions to enable

**Events Emitted:**
- `AgentToolsEnabled`

## Queries

### GetAgentById

Retrieves an agent by its identifier.

```rust
use cim_domain_agent::queries::{AgentQuery, AgentQueryHandler};

let query = AgentQuery::GetById { id: agent_id };
let result = query_handler.handle(query).await?;
```

**Returns:** `Option<AgentView>`

### ListAgentsByOwner

Lists all agents owned by a specific user or organization.

```rust
use cim_domain_agent::queries::AgentQuery;

let query = AgentQuery::ListByOwner { 
    owner_id,
    include_inactive: false,
};
```

**Returns:** `Vec<AgentView>`

### ListAgentsByType

Lists all agents of a specific type.

```rust
use cim_domain_agent::queries::AgentQuery;
use cim_domain_agent::AgentType;

let query = AgentQuery::ListByType { 
    agent_type: AgentType::Assistant,
};
```

**Returns:** `Vec<AgentView>`

## Events

### AgentDeployed

Emitted when a new agent is deployed.

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AgentDeployed {
    pub id: Uuid,
    pub agent_type: AgentType,
    pub owner_id: Uuid,
    pub metadata: AgentMetadata,
    pub timestamp: SystemTime,
}
```

### AgentActivated

Emitted when an agent is activated.

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AgentActivated {
    pub id: Uuid,
    pub timestamp: SystemTime,
}
```

### AgentSuspended

Emitted when an agent is suspended.

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AgentSuspended {
    pub id: Uuid,
    pub reason: String,
    pub timestamp: SystemTime,
}
```

### AgentCapabilitiesAdded

Emitted when capabilities are added to an agent.

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AgentCapabilitiesAdded {
    pub id: Uuid,
    pub capabilities: Vec<String>,
    pub timestamp: SystemTime,
}
```

## Value Objects

### AgentType

Represents the type of agent.

```rust
#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]
pub enum AgentType {
    Assistant,  // General-purpose assistant
    Analyzer,   // Data analysis specialist
    Executor,   // Task execution specialist
    Monitor,    // System monitoring agent
}
```

### AgentStatus

Represents the current status of an agent.

```rust
#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]
pub enum AgentStatus {
    Deployed,
    Active,
    Suspended,
    Offline,
    Decommissioned,
}
```

### AgentMetadata

Contains descriptive information about an agent.

```rust
#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub struct AgentMetadata {
    pub name: String,
    pub description: Option<String>,
    pub version: String,
    pub tags: Vec<String>,
    pub created_at: SystemTime,
    pub updated_at: SystemTime,
}
```

### ToolDefinition

Defines a tool that an agent can use.

```rust
#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub struct ToolDefinition {
    pub name: String,
    pub version: String,
    pub endpoint: Option<String>,
    pub parameters: HashMap<String, Value>,
}
```

## Error Handling

The domain uses the following error types:

```rust
#[derive(Debug, thiserror::Error)]
pub enum AgentError {
    #[error("Agent not found: {id}")]
    NotFound { id: Uuid },
    
    #[error("Invalid state transition from {from:?} to {to:?}")]
    InvalidStateTransition { from: AgentStatus, to: AgentStatus },
    
    #[error("Permission denied: {reason}")]
    PermissionDenied { reason: String },
    
    #[error("Invalid configuration: {reason}")]
    InvalidConfiguration { reason: String },
}
```

## Usage Examples

### Creating and Activating an Agent

```rust
use cim_domain_agent::{
    commands::{DeployAgent, ActivateAgent},
    handlers::AgentCommandHandler,
    AgentType, AgentMetadata,
};

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    let handler = AgentCommandHandler::new();
    
    // Deploy the agent
    let deploy_cmd = DeployAgent {
        id: Uuid::new_v4(),
        agent_type: AgentType::Assistant,
        owner_id: user_id,
        metadata: AgentMetadata {
            name: "Research Assistant".to_string(),
            description: Some("Helps with research tasks".to_string()),
            version: "1.0.0".to_string(),
            tags: vec!["research".to_string(), "ai".to_string()],
            ..Default::default()
        },
    };
    
    let events = handler.handle(deploy_cmd).await?;
    
    // Activate the agent
    let activate_cmd = ActivateAgent {
        id: agent_id,
    };
    
    let events = handler.handle(activate_cmd).await?;
    
    Ok(())
}
```

### Configuring Agent Tools and Permissions

```rust
use cim_domain_agent::{
    commands::{EnableAgentTools, GrantAgentPermissions},
    ToolDefinition,
};
use std::collections::HashSet;

// Enable tools
let enable_tools = EnableAgentTools {
    id: agent_id,
    tools: vec![
        ToolDefinition {
            name: "web_search".to_string(),
            version: "2.0".to_string(),
            endpoint: Some("https://api.search.com".to_string()),
            parameters: Default::default(),
        },
        ToolDefinition {
            name: "document_reader".to_string(),
            version: "1.5".to_string(),
            endpoint: None,
            parameters: Default::default(),
        },
    ],
};

// Grant permissions
let grant_perms = GrantAgentPermissions {
    id: agent_id,
    permissions: HashSet::from([
        "read:documents".to_string(),
        "write:reports".to_string(),
        "execute:analysis".to_string(),
    ]),
};
```

## Integration with Other Domains

This domain integrates with:

- **Identity Domain**: Agents are associated with identity owners
- **Dialog Domain**: Agents participate in conversations
- **Workflow Domain**: Agents can execute workflow steps
- **Policy Domain**: Agent permissions are enforced through policies

## Performance Considerations

- Commands are processed asynchronously
- Agent views are cached for fast retrieval
- Tool configurations are validated at enable time
- Permission checks are optimized with bitmap indices

## Security Considerations

- All agent operations require owner authentication
- Permissions are enforced at the command handler level
- Tool endpoints are validated before enabling
- Sensitive configuration values are encrypted 